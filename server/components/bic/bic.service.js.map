{"version":3,"sources":["../../../../server/components/bic/bic.service.js"],"names":[],"mappings":"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","file":"bic.service.js","sourcesContent":["\n'use strict';\n\n\nimport _ from 'lodash';\nimport elasticlunr from 'elasticlunr';\nimport request from 'request-promise';\nimport FuzzySet from 'fuzzyset.js';\nvar jsonfile = require('bluebird').promisifyAll(require('jsonfile'));\n\nlet bicIndex, createBicIndex, bicStore = {}, createFuzzyIndex, fuzzyIndex;\n\nconst INDUSTRIES_URL = `https://api.businessdescription.co.nz/api/industries`;\nconst DIVISIONS_URL = `https://api.businessdescription.co.nz/api/industries/{{industryId}}/divisions`;\nconst CLASSES_URL = `https://api.businessdescription.co.nz/api/divisions/{{divisionId}}/classes`;\nconst BICS_URL = `https://api.businessdescription.co.nz/api/bics?filter[include]=cu&filter[include]=anzsic&filter[include]=bicrefs&filter[include]=historyBic`;\nconst BICS_SEED_FILENAME =`${__dirname}/../../config/seed/bic.json`;\n\n\nexport function search(query){\n  return Promise.all([\n    getIndex(),\n    getFuzzy()\n  ])\n    .then(([index, fuzzy]) => {\n\n      //TODO break up query with fuzzy tokens\n\n      let tokens = getQueryTokens(query);\n      let expandedQuery = _(tokens).map(token => {\n        let matches = fuzzy.get(token);\n        return _((matches || []).concat([1, token]))\n          .map(match => { console.log(match); return match[0] >= 0.75 ? match[1] : undefined; })\n          .filter()\n          .uniq()\n          .value()\n          .join(' ');\n\n      }).value().join(' ');\n\n      console.log('Bic search query', query, expandedQuery);\n\n      return _(index.search(expandedQuery)).map(result => {\n        return bicStore[result.ref];\n      }).value();\n    });\n}\n\nfunction getIndex(){\n  return bicIndex ? Promise.resolve(bicIndex) : generateIndex();\n}\n\nfunction getFuzzy(){\n  return fuzzyIndex ? Promise.resolve(fuzzyIndex) : generateFuzzy();\n}\n\nfunction generateFuzzy() {\n\n  return createFuzzyIndex ? createFuzzyIndex :\n    createFuzzyIndex = index()\n    .then(bics => {\n\n      let bicDescriptions = _(bics).map(function (bic) {\n        bic.keywordsFlattened = bic.keywords && bic.keywords.join(' ') || '';\n        return (`${bic.desc} ${bic.keywordsFlattened} ${bic.industryName} ${bic.divisionName} ${bic.definitionPlainText}`).split(' ');\n      })\n      .flatten()\n      .map(word => word.replace(/\\.|\\(|\\)|\\\\|'|,|:/gi, ' ').split(' '))\n      .flatten()\n      .map(word => word && word.toLowerCase().trim())\n      .filter()\n      .uniq()\n      .filter(word => elasticlunr.stopWordFilter(word))\n      .filter(word => ! /^\\d+$/.test(word))\n      .filter(word => word.length >= 3)\n      .filter(word => word !== '-')\n      .value();\n\n      return FuzzySet(bicDescriptions);\n    });\n}\n\n\nfunction generateIndex(){\n  return createBicIndex ? createBicIndex  :\n    createBicIndex = index()\n      .then(bics => {\n\n        console.log('Generating bic index');\n\n        //elasticlunr.Configuration({fields: {}});\n\n        var idx = elasticlunr(function() {\n          this.setRef('code');\n\n          this.addField('code');\n          this.addField('desc');\n\n          this.addField('industryName');\n          this.addField('divisionName');\n          this.addField('className');\n          this.addField('cu');\n          this.addField('anzsic');\n\n          this.addField('keywordsFlattened');\n          this.addField('definitionPlainText');\n\n          this.saveDocument(false);\n        });\n\n        idx.pipeline.add(\n          elasticlunr.trimmer,\n          elasticlunr.stopWordFilter,\n          elasticlunr.stemmer\n        );\n\n        //TODO promise this as to not halt event que?\n\n        bicStore = {};\n\n        return delay(1000).then(()=> {\n          return Promise.all(_.map(bics, (bic, index) => {\n            return delay(index).then(() => {\n              bic.keywordsFlattened = bic.keywords && bic.keywords.join(' ') || '';\n              idx.addDoc(bic);\n              bicStore[bic.code.toString()] = bic;\n            });\n          }));\n        })\n        .then(bics => {\n            return bicIndex = idx; //jshint ignore:line\n          });\n\n      });\n\n}\n\n\nexport function index(){\n  return Promise.resolve()\n    .then(() => {\n      //TODO should seed properly and use database\n      return jsonfile.readFileAsync(BICS_SEED_FILENAME)\n      .catch(err => {return {};})\n      .then(bics => {\n\n          if(bics && bics.length > 0) { return bics; }\n\n          let bicsRequest = request(getBicsRequest());\n\n          return request(getIndustriesRequest())\n            .then(industries => {\n\n              return Promise.all(_(industries).map(industry => {\n                return request(getDivisionsRequest(industry.id))\n                  .then(divisions => {\n                    return _(divisions).map(division => {\n                      division.industryName = industry.name;\n                      return division;\n                    }).value();\n                  });\n              }).value())\n\n                .then(divisions => {\n                  return Promise.all(_(divisions).flatten().map(division => {\n                    return request(getClassesRequest(division.id))\n                      .then(classes => {\n                        return _(classes).map(clazz => {\n                          clazz.divisionName = division.name;\n                          clazz.industryName = division.industryName;\n                          clazz.industryId = division.industryId;\n                          return clazz;\n                        }).value();\n                      });\n                  }).value())\n\n                    .then(classes => {\n                      return bicsRequest.then(bics => {\n\n                        console.log('Fetched external /api/bics length', bics.length);\n\n                        let classesFormatted = _(classes).flatten().map(clazz => {\n                          clazz.className = clazz.name;\n                          clazz.classId = clazz.id;\n                          return clazz;\n                        }).value();\n\n                        return _(bics).map(bic => {\n                          return _.merge({}, bic, _.find(classesFormatted, _.matchesProperty('id', bic.classId)));\n                        })\n                        .map(bic => {\n                          return _.omit(bic, 'id', 'name', 'anzsicId', 'cuId', 'definition', 'important', 'lastUpdateDate', 'lastUpdateUserId');\n                        })\n                        .map(bic => {\n                          bic.cu = bic.cu.code;\n                          bic.anzsic = bic.anzsic.code;\n                          return bic;\n                        })\n                        .value();\n\n                      });\n                    })\n                    .then(bics => {\n                      //Cache to seed folder\n                      jsonfile.writeFileAsync(BICS_SEED_FILENAME, bics);\n                      return bics;\n                    });\n                });\n            });\n        })\n        .then(bics => {\n          console.log('Service bics length', bics.length);\n          return bics;\n        });\n    });\n}\n\n\nfunction getIndustriesRequest(){\n  return _.merge({ uri: getIndustriesUrl() }, getBaseRequest());\n}\n\nfunction getDivisionsRequest(industryId){\n  return _.merge({ uri: getDivisionsUrl(industryId) }, getBaseRequest());\n}\n\nfunction getClassesRequest(divisionId){\n  return _.merge({ uri: getClassesUrl(divisionId) }, getBaseRequest());\n}\nfunction getBicsRequest(){\n  return _.merge({ uri: getBicsUrl() }, getBaseRequest());\n}\n\nfunction getBaseRequest(){\n  return {\n    rejectUnauthorized: false,\n    requestCert: true,\n    json: true\n  }\n}\n\nfunction getIndustriesUrl(){\n  return INDUSTRIES_URL;\n}\n\nfunction getBicsUrl(){\n  return BICS_URL;\n}\n\nfunction getDivisionsUrl(industryId){\n  if(!industryId){ throw new Error('No industry id passed')}\n  return DIVISIONS_URL.replace('{{industryId}}', industryId);\n}\n\nfunction getClassesUrl(divisionId){\n  if(!divisionId){ throw new Error('No division id passed')}\n  return CLASSES_URL.replace('{{divisionId}}', divisionId);\n}\n\nfunction delay(time = 0){\n  return new Promise(resolve => setTimeout(resolve, time));\n}\n\nfunction getQueryTokens(query = ''){\n  return _(query.split(/\\b|\\./)).filter().map(token => token.trim()).filter().value();\n}\n"]}